<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Ripit</title>
    <link rel="stylesheet" href="index.css" />
  </head>
  <body>
    <div id="titleBar">
      <div id="title">Ripit</div>
      <div id="windowControls">
        <button id="minimizeButton">_</button>
        <button id="maximizeButton">⬜</button>
        <button id="closeButton">✕</button>
      </div>
    </div>
    <div id="content">
      <h1>Ripit</h1>
      <div>
        <input type="text" id="urlInput" placeholder="Enter URL to download" />
        <button id="downloadButton">Download</button>
        <p id="errorMessage" style="color: red; display: none;">Invalid URL</p>
        <progress id="progressBar" value="0" max="100" style="width: 100%; display: none;"></progress>
        <p id="progressDetails" style="display: none;">0% | ETA: -- | Speed: --</p>
      </div>
      <div id="qualityDialog" style="display: none; border: 1px solid #ccc; padding: 1rem; background: #f9f9f9;">
        <h3>Select Video Quality</h3>
        <div id="resolutionOptions">
          <p>Loading available resolutions...</p>
        </div>
        <button id="confirmQualityButton" disabled>Confirm</button>
      </div>
      <p id="statusText" style="margin-top: 1rem;">Idle</p>
    </div>
    <script>
      let lastUpdateTime = 0;

      // Notify the main process when content changes
      function notifyContentUpdated() {
        window.electronAPI.notifyContentUpdated();
      }

      function isValidUrl(url) {
        try {
          new URL(url);
          return true;
        } catch {
          return false;
        }
      }

      function isYouTubeUrl(url) {
        const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+$/;
        return youtubeRegex.test(url);
      }

      async function populateResolutions(url) {
        const resolutionOptions = document.getElementById('resolutionOptions');
        const confirmButton = document.getElementById('confirmQualityButton');
        resolutionOptions.innerHTML = '<p>Loading available resolutions...</p>';
        confirmButton.disabled = true;
        notifyContentUpdated(); // Notify content update
        try {
          console.log(`Fetching resolutions for URL: ${url}`);
          const resolutions = await window.electronAPI.fetchVideoResolutions(url);
          console.log('Fetched resolutions:', resolutions);

          const uniqueResolutions = resolutions.filter(
            (res, index, self) =>
              index === self.findIndex((r) => r.resolution === res.resolution)
          );
          console.log('Unique resolutions:', uniqueResolutions);

          if (uniqueResolutions.length === 0) {
            resolutionOptions.innerHTML = '<p>No supported resolutions available.</p>';
            console.log('No supported resolutions available.');
            notifyContentUpdated(); // Notify content update
            return;
          }

          resolutionOptions.innerHTML = uniqueResolutions
            .map(
              (res) =>
                `<label>
                  <input type="radio" name="quality" data-format="${res.format}" value="${res.resolution}" />
                  ${res.resolution === 'audio only' 
                    ? `<img src="../icons/audio.svg" style="height: 1em; vertical-align: middle; margin-right: 4px;" />`
                    : ''
                  }${res.resolution} (${res.size})
                </label><br />`
            )
            .join('');
          confirmButton.disabled = false;
          console.log('Resolution options populated.');
          notifyContentUpdated(); // Notify content update
        } catch (error) {
          resolutionOptions.innerHTML = '<p>Failed to load resolutions.</p>';
          console.error('Error fetching resolutions:', error);
          notifyContentUpdated(); // Notify content update
        }
      }

      function updateProgress({ progress, eta, speed }) {
        const progressBar = document.getElementById('progressBar');
        const progressDetails = document.getElementById('progressDetails');
        const statusText = document.getElementById('statusText');

        console.log('Updating progress bar with data:', { progress, eta, speed });

        // Ensure progress is a valid number
        const validProgress = isFinite(progress) ? progress : 0;

        progressBar.value = validProgress;
        progressDetails.textContent = `${validProgress.toFixed(2)}% | ETA: ${eta} | Speed: ${speed}`;
        progressDetails.style.display = 'block';

        if (validProgress === 100) {
          progressBar.value = 100; // Force update to 100%
          progressBar.style.backgroundColor = 'green';
          statusText.textContent = 'Download complete!';
          console.log('Download complete!');
        } else {
          statusText.textContent = 'Downloading...';
        }
      }

      function resetProgressBar() {
        const progressBar = document.getElementById('progressBar');
        const progressDetails = document.getElementById('progressDetails');
        const statusText = document.getElementById('statusText');

        progressBar.value = 0;
        progressBar.style.backgroundColor = '';
        progressBar.style.display = 'none';
        progressDetails.textContent = '0% | ETA: -- | Speed: --';
        progressDetails.style.display = 'none';
        statusText.textContent = 'Idle';
      }

      document.getElementById('downloadButton').addEventListener('click', async () => {
        const url = document.getElementById('urlInput').value;
        if (!isValidUrl(url)) {
          alert('Invalid URL');
          return;
        }
        if (!isYouTubeUrl(url)) {
          alert('This URL is not a valid YouTube link.');
          return;
        }

        // Open the resolution selector dialog
        window.electronAPI.openResolutionDialog(url);
      });

      // Handle resolution selection
      window.electronAPI.onResolutionSelected((resolution) => {
        console.log('Resolution selected in main window:', resolution);
        // Proceed with the download logic here
      });

      window.electronAPI.onDownloadProgress((data) => {
        const progressBar = document.getElementById('progressBar');
        const progressDetails = document.getElementById('progressDetails');
        const statusText = document.getElementById('statusText');

        console.log('Updating progress bar with data:', data);

        const validProgress = isFinite(data.progress) ? data.progress : 0;

        progressBar.value = validProgress;
        progressDetails.textContent = `${validProgress.toFixed(2)}% | ETA: ${data.eta} | Speed: ${data.speed}`;
        progressDetails.style.display = 'block';

        if (validProgress === 100) {
          progressBar.style.backgroundColor = 'green';
          statusText.textContent = 'Download complete!';
          console.log('Download complete!');
        } else {
          statusText.textContent = 'Downloading...';
        }
      });

      window.electronAPI.onDownloadError((message) => {
        alert(`Error: ${message}`);
        resetProgressBar(); // Reset progress bar on error
      });

      // Add event listeners for custom window controls
      document.getElementById('minimizeButton').addEventListener('click', () => {
        window.electronAPI.minimizeWindow();
      });

      document.getElementById('maximizeButton').addEventListener('click', () => {
        window.electronAPI.maximizeWindow();
      });

      document.getElementById('closeButton').addEventListener('click', () => {
        window.electronAPI.closeWindow();
      });
    </script>
  </body>
</html>
